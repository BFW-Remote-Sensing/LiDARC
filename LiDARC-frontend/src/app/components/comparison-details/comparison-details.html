@if (loading()) {
<div class="flex-center">
    <mat-spinner></mat-spinner>
</div>
}
@else if (!loading() && !comparison && !errorMessage()) {
<app-text-card type="info" message="No file found."></app-text-card>
}
@else if (errorMessage()) {
<app-text-card type="error" message="{{ errorMessage() }}"></app-text-card>
}
@else if(comparison) {
<div class="file-details-container">

    <header class="metadata-header mat-elevation-z2">
        <mat-icon class="header-icon">description</mat-icon>
        <h1>Comparison Details: {{ comparison.name }}</h1>
    </header>

    <div class="content-wrapper">

        <section class="general-info-section">
            <h2><mat-icon>info</mat-icon> General Information</h2>
            <mat-list role="list">

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>adjust</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Status
                        </span>
                        <span>
                            {{ comparison.status | titlecase }}
                        </span>
                    </div>
                </mat-list-item>
                <mat-divider></mat-divider>

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>calendar_today</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Created At
                        </span>
                        <span>
                            {{ comparison.createdAt ? (comparison.createdAt | date:'medium') : 'N/A' }}
                        </span>
                    </div>
                </mat-list-item>
                <mat-divider></mat-divider>

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Highest Vegetation
                        </span>
                        <span>
                            <mat-icon [color]="comparison.needHighestVegetation ? 'primary' : 'warn'">
                                {{ comparison.needHighestVegetation ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </span>
                    </div>
                </mat-list-item>
                <mat-divider></mat-divider>

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Outlier Detection
                        </span>
                        <span>
                            <mat-icon [color]="comparison.needOutlierDetection ? 'primary' : 'warn'">
                                {{ comparison.needOutlierDetection ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </span>
                    </div>
                </mat-list-item>
                <mat-divider></mat-divider>

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Statistics Over Scenery
                        </span>
                        <span>
                            <mat-icon [color]="comparison.needStatisticsOverScenery ? 'primary' : 'warn'">
                                {{ comparison.needStatisticsOverScenery ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </span>
                    </div>
                </mat-list-item>
                <mat-divider></mat-divider>

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
                    <div matListItemTitle class="mat-list-item-row">
                        <span>
                            Most Differences
                        </span>
                        <span>
                            <mat-icon [color]="comparison.needMostDifferences ? 'primary' : 'warn'">
                                {{ comparison.needMostDifferences ? 'check_circle' : 'cancel' }}
                            </mat-icon>
                        </span>
                    </div>
                </mat-list-item>
            </mat-list>
            <h2 style="margin-top: 20px;"><mat-icon>folder</mat-icon>Compared Files</h2>
            <mat-list role="list">
                @for (file of comparison.files; track file.id; let last = $last) {

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>insert_drive_file</mat-icon>

                    <div matListItemTitle class="mat-list-item-row">
                        <span class="file-name">
                            {{ file.originalFilename | titlecase }}
                        </span>

                        <span>
                            <a [routerLink]="['/stored-files', file.id]">
                                <button mat-icon-button matTooltip="View Details" matTooltipPosition="right">
                                    <mat-icon>visibility</mat-icon>
                                </button>
                            </a>
                        </span>
                    </div>
                </mat-list-item>

                @if (!last) {
                <mat-divider></mat-divider>
                }}
            </mat-list>

        </section>

        <mat-divider vertical="true"></mat-divider>

        <section class="technical-info-section">
            <h2><mat-icon>grid_on</mat-icon>Grid Parameters</h2>

            <div class="bounding-box-flex align-center">
                <h4>
                    Cell Width:
                    <span class="coordinate">
                        {{ comparison.grid?.cellWidth != null ? (comparison.grid?.cellWidth | number:'1.2-6') : 'N/A' }}
                        m
                    </span>
                </h4>
                <h4>
                    Cell Height:
                    <span class="coordinate">
                        {{ comparison.grid?.cellHeight != null ? (comparison.grid?.cellHeight | number:'1.2-6') : 'N/A'
                        }} m
                    </span>
                </h4>
            </div>
            <mat-divider></mat-divider>
            <div class="bounding-box-flex align-center">
                <h4>
                    X<sub style="font-size: 0.6em;">min</sub>:
                    <span class="coordinate">
                        {{ comparison.grid?.xMin != null ? (comparison.grid?.xMin | number:'1.2-6') : 'N/A' }}
                    </span>
                </h4>
                <mat-icon>east</mat-icon>
                <h4>
                    X<sub style="font-size: 0.6em;">max</sub>:
                    <span class="coordinate">
                        {{ comparison.grid?.xMax != null ? (comparison.grid?.xMax | number:'1.2-6') : 'N/A' }}
                    </span>
                </h4>
            </div>
            <mat-divider></mat-divider>
            <div class="bounding-box-flex align-center">
                <h4>
                    Y<sub style="font-size: 0.6em;">min</sub>:
                    <span class="coordinate">
                        {{ comparison.grid?.yMin != null ? (comparison.grid?.yMin | number:'1.2-6') : 'N/A' }}
                    </span>
                </h4>
                <mat-icon>east</mat-icon>
                <h4>
                    Y<sub style="font-size: 0.6em;">max</sub>:
                    <span class="coordinate">
                        {{ comparison.grid?.yMax != null ? (comparison.grid?.yMax | number:'1.2-6') : 'N/A' }}
                    </span>
                </h4>
            </div>
            <h2 style="margin-top: 10px;"><mat-icon>assignment</mat-icon>Reports</h2>
            <mat-list role="list">
                @for (report of reports; track report.id; let last = $last) {

                <mat-list-item role="listitem">
                    <mat-icon matListItemIcon>insert_drive_file</mat-icon>

                    <div matListItemTitle class="mat-list-item-row">
                        <span class="file-name">
                            {{ report.title | titlecase }}
                        </span>

                        <span>
                            {{ report.fileName | titlecase }}
                        </span>
                    </div>
                </mat-list-item>

                @if (!last) {
                <mat-divider></mat-divider>
                }}
                @if (reports.length === 0) {
                <mat-list-item role="listitem">
                    <div matListItemTitle class="mat-list-item-row">
                        <span style="font-style: italic; color: gray; margin-left: 10px;">
                            No reports available.
                        </span>
                    </div>
                </mat-list-item>
                }
            </mat-list>
        </section>
    </div>
</div>

<!-- ===== HARDCODED COMPARISON VISUALIZATION ===== -->
<div class="file-details-container">
  <mat-divider style="margin: 40px 0;"></mat-divider>
  <h2><mat-icon>analytics</mat-icon>Comparison Results</h2>
  <div class="comparison-container">

    <!-- ===== File Metrics Section ===== -->
    <mat-card class="section-card">
      <mat-card-title>File Specific Metrics of Highest Vegetational Points</mat-card-title>
      <mat-divider></mat-divider>
      <mat-card-content>
        <div class="metrics-list">
          <mat-list>
            <h4>File A</h4>
            <mat-list-item>Mean: {{vegetationStats.fileA_metrics.mean}}</mat-list-item>
            <mat-list-item>Median: {{vegetationStats.fileA_metrics.median}}</mat-list-item>
            <mat-list-item>Std: {{vegetationStats.fileA_metrics.std}}</mat-list-item>
            <mat-list-item>Min: {{vegetationStats.fileA_metrics.min}}</mat-list-item>
            <mat-list-item>Max: {{vegetationStats.fileA_metrics.max}}</mat-list-item>
          </mat-list>

          <mat-list>
            <h4>File B</h4>
            <mat-list-item>Mean: {{vegetationStats.fileB_metrics.mean}}</mat-list-item>
            <mat-list-item>Median: {{vegetationStats.fileB_metrics.median}}</mat-list-item>
            <mat-list-item>Std: {{vegetationStats.fileB_metrics.std}}</mat-list-item>
            <mat-list-item>Min: {{vegetationStats.fileB_metrics.min}}</mat-list-item>
            <mat-list-item>Max: {{vegetationStats.fileB_metrics.max}}</mat-list-item>
          </mat-list>
        </div>

        <div class="charts-grid">
          <div echarts [options]="scatterOption" class="chart"></div>
          <div echarts [options]="boxplotOption" class="chart"></div>
          <div echarts [options]="fileDistributionOption" class="chart"></div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ===== Difference Metrics Section ===== -->
    <mat-card class="section-card">
      <mat-card-title>Difference Metrics (B - A)</mat-card-title>
      <mat-divider></mat-divider>
      <mat-card-content>
        <p>The difference metrics show how much the maximum vegetational height of File B differs from the one of File A for each cell.</p>

        <mat-list>
          <mat-list-item>Mean: {{vegetationStats.difference_metrics.mean}}</mat-list-item>
          <mat-list-item>Median: {{vegetationStats.difference_metrics.median}}</mat-list-item>
          <mat-list-item>Std: {{vegetationStats.difference_metrics.std}}</mat-list-item>
          <mat-list-item>Most Negative: {{vegetationStats.difference_metrics.mostNegative}}</mat-list-item>
          <mat-list-item>Least Negative: {{vegetationStats.difference_metrics.leastNegative}}</mat-list-item>
          <mat-list-item>Smallest Positive: {{vegetationStats.difference_metrics.smallestPositive}}</mat-list-item>
          <mat-list-item>Largest Positive: {{vegetationStats.difference_metrics.largestPositive}}</mat-list-item>
        </mat-list>

        <div class="charts-grid">
          <div echarts [options]="diffDistributionOption" class="chart"></div>
          <div echarts [options]="diffHistogramOption" class="chart"></div>
          <div echarts [options]="categoryBarChart" class="chart"></div>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

</div>




}
