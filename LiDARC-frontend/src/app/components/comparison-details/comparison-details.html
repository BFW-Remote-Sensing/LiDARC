@if (loading()) {
<div class="flex-center">
  <mat-spinner></mat-spinner>
</div>
} @else if (!loading() && !comparison && !errorMessage()) {
<app-text-card type="info" message="No file found."></app-text-card>
} @else if (errorMessage()) {
<app-text-card type="error" message="{{ errorMessage() }}"></app-text-card>
} @else if (comparison()) {
<div class="file-details-container">

  <header class="metadata-header mat-elevation-z2">
    <mat-icon class="header-icon">description</mat-icon>
    <h1>Comparison Details: {{ comparison()!.name }}</h1>
    <button mat-raised-button color="primary" (click)="createReport()" style="width: 180px;"
      [disabled]="comparison()!.status !== 'COMPLETED'">
      Create Report
    </button>
  </header>


  <div class="content-wrapper">

    <section class="general-info-section">
      <h2>
        <mat-icon>info</mat-icon>
        General Information
      </h2>
      <mat-list role="list">

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>adjust</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Status
            </span>
            <div class="status-column">
              <span [ngClass]="{
        'status-ready': comparison()!.status === 'COMPLETED',
        'status-error': comparison()!.status === 'FAILED',
        'status-default': ['PREPROCESSING', 'COMPARING'].includes(comparison()!.status)
    }">{{ comparison()!.status | titlecase }}</span>
              @if (['PREPROCESSING', 'COMPARING'].includes(comparison()!.status)) {
              <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
              }
              @else if (comparison()!.status === 'FAILED') {
              <mat-icon [matTooltip]="comparison()!.errorMessage" matTooltipPosition="above">
                error
              </mat-icon>
              }
            </div>
          </div>
        </mat-list-item>
        <mat-divider></mat-divider>

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>calendar_today</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Created At
            </span>
            <span>
              {{ comparison()?.createdAt ? (comparison()!.createdAt | date: 'MMM d, y, HH:mm') : 'N/A' }}
            </span>
          </div>
        </mat-list-item>
        <mat-divider></mat-divider>

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Highest Vegetation
            </span>
            <span>
              <mat-icon [color]="comparison()!.needHighestVegetation ? 'primary' : 'warn'">
                {{ comparison()!.needHighestVegetation ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </span>
          </div>
        </mat-list-item>
        <mat-divider></mat-divider>

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Outlier Detection
            </span>
            <span>
              <mat-icon [color]="comparison()!.needOutlierDetection ? 'primary' : 'warn'">
                {{ comparison()!.needOutlierDetection ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </span>
          </div>
        </mat-list-item>
        <mat-divider></mat-divider>

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Statistics Over Scenery
            </span>
            <span>
              <mat-icon [color]="comparison()!.needStatisticsOverScenery ? 'primary' : 'warn'">
                {{ comparison()!.needStatisticsOverScenery ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </span>
          </div>
        </mat-list-item>
        <mat-divider></mat-divider>

        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>bar_chart_4_bars</mat-icon>
          <div matListItemTitle class="mat-list-item-row">
            <span>
              Most Differences
            </span>
            <span>
              <mat-icon [color]="comparison()!.needMostDifferences ? 'primary' : 'warn'">
                {{ comparison()!.needMostDifferences ? 'check_circle' : 'cancel' }}
              </mat-icon>
            </span>
          </div>
        </mat-list-item>
      </mat-list>
      <h2 style="margin-top: 20px;">
        <mat-icon>folder</mat-icon>
        Compared Items
      </h2>
      <mat-list role="list">
        @for (item of comparedItems; track item.id; let last = $last) {
        <mat-list-item role="listitem">
          <mat-icon matListItemIcon>
            {{ item.type === 'file' ? 'insert_drive_file' : 'folder' }}
          </mat-icon>

          <div matListItemTitle class="mat-list-item-row">
            <span class="file-name">{{ item.name | titlecase }}</span>

            <span>
              <a [routerLink]="[item.type === 'file' ? '/stored-files' : '/folders', item.id]">
                <button mat-icon-button matTooltip="View Details" matTooltipPosition="right">
                  <mat-icon>visibility</mat-icon>
                </button>
              </a>
            </span>
          </div>
        </mat-list-item>

        @if (!last) {
        <mat-divider></mat-divider>
        }
        }
      </mat-list>

    </section>

    <mat-divider vertical="true"></mat-divider>

    <section class="technical-info-section">
      <h2>
        <mat-icon>grid_on</mat-icon>
        Grid Parameters
      </h2>

      <div class="bounding-box-flex align-center">
        <h4>
          Cell Width:
          <span class="coordinate">
            {{ comparison()!.grid?.cellWidth != null ? (comparison()!.grid?.cellWidth | number:'1.2-6') : 'N/A' }}
            m
          </span>
        </h4>
        <h4>
          Cell Height:
          <span class="coordinate">
            {{
            comparison()!.grid?.cellHeight != null ? (comparison()!.grid?.cellHeight | number:'1.2-6') : 'N/A'
            }} m
          </span>
        </h4>
      </div>
      <mat-divider></mat-divider>
      <div class="bounding-box-flex align-center">
        <h4>
          X<sub style="font-size: 0.6em;">min</sub>:
          <span class="coordinate">
            {{ comparison()!.grid?.xMin != null ? (comparison()!.grid?.xMin | number:'1.2-6') : 'N/A' }}
          </span>
        </h4>
        <mat-icon>east</mat-icon>
        <h4>
          X<sub style="font-size: 0.6em;">max</sub>:
          <span class="coordinate">
            {{ comparison()!.grid?.xMax != null ? (comparison()!.grid?.xMax | number:'1.2-6') : 'N/A' }}
          </span>
        </h4>
      </div>
      <mat-divider></mat-divider>
      <div class="bounding-box-flex align-center">
        <h4>
          Y<sub style="font-size: 0.6em;">min</sub>:
          <span class="coordinate">
            {{ comparison()!.grid?.yMin != null ? (comparison()!.grid?.yMin | number:'1.2-6') : 'N/A' }}
          </span>
        </h4>
        <mat-icon>east</mat-icon>
        <h4>
          Y<sub style="font-size: 0.6em;">max</sub>:
          <span class="coordinate">
            {{ comparison()!.grid?.yMax != null ? (comparison()!.grid?.yMax | number:'1.2-6') : 'N/A' }}
          </span>
        </h4>
      </div>

      <h2 style="margin-top: 20px;">
        <mat-icon>filter_alt</mat-icon>
        Point Filter Settings
      </h2>
      <div class="bounding-box-flex align-center">
        <h4>
          Lower Bound:
          <span class="coordinate">
            {{ comparison()!.pointFilterLowerBound != null ? comparison()!.pointFilterLowerBound : 0 }}%
          </span>
        </h4>
        <mat-icon>east</mat-icon>
        <h4>
          Upper Bound:
          <span class="coordinate">
            {{ comparison()!.pointFilterUpperBound != null ? comparison()!.pointFilterUpperBound : 100 }}%
          </span>
        </h4>
      </div>
      @if (comparison()!.pointFilterLowerBound != null && comparison()!.pointFilterLowerBound !== 0 ||
      comparison()!.pointFilterUpperBound != null && comparison()!.pointFilterUpperBound !== 100) {
      <div style="padding: 8px 0; font-size: 0.9em; color: #666;">
        <mat-icon style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
        Points filtered to {{ comparison()!.pointFilterLowerBound ?? 0 }}th-{{ comparison()!.pointFilterUpperBound ?? 100 }}th
        percentile based on vegetation height
      </div>
      }

      <h2 style="margin-top: 10px;">
        <mat-icon>assignment</mat-icon>
        Reports
      </h2>
      <div class="reports-scroll-container">
        <mat-nav-list role="navigation">
          @for (report of reports(); track report.id; let last = $last) {

          <mat-list-item class="report-row">
            <mat-icon matListItemIcon>assessment</mat-icon>

            <span matListItemTitle>
              {{ report.title | titlecase }}
            </span>
            <span matListItemLine class="date-line">
              Created At: {{ report.creationDate | date:'mediumDate' }} {{ report.creationDate | date:'shortTime' }}
            </span>
            <a [href]="this.globals.backendUri + '/reports/' + report.id + '/view'" target="_blank"
              rel="noopener noreferrer" class="row-overlay-link" aria-label="View Report" matTooltip="View Report">
            </a>
            <span matListItemMeta>
              <a mat-icon-button [href]="this.globals.backendUri + '/reports/' + report.id + '/download'"
                target="_blank" download class="action-button" matTooltip="Download Report">
                <mat-icon>download</mat-icon>
              </a>
              <button mat-icon-button color="warn" (click)="deleteReport(report.id, report.title)"
                matTooltip="Delete Report" class="action-button">
                <mat-icon>delete</mat-icon>
              </button>
            </span>
          </mat-list-item>
          @if (!last) {
          <mat-divider></mat-divider>
          }
          }
          @if (reports().length === 0) {
          <mat-list-item role="listitem">
            <div matListItemTitle class="mat-list-item-row">
              <span style="font-style: italic; color: gray; margin-left: 10px;">
                No reports available.
              </span>
            </div>
          </mat-list-item>
          }
        </mat-nav-list>
      </div>
      @if (hasMoreReports() && reports().length > 0) {
      <div class="load-more-container">
        @if (reportsLoading()) {
        <mat-spinner diameter="30"></mat-spinner>
        } @else {
        <button mat-stroked-button color="primary" (click)="loadMoreReports()">
          Load More
          <mat-icon>expand_more</mat-icon>
        </button>
        }
      </div>
      }
    </section>
  </div>
</div>
<!-- ===== HARDCODED COMPARISON VISUALIZATION ===== -->
@if (comparison()!.status !== 'FAILED') {
<div class="file-details-container">
  <mat-divider style="margin: 40px 0;"></mat-divider>
  <h2>
    <mat-icon>analytics</mat-icon>
    Comparison Results
  </h2>
  @if (comparison()!.status === 'COMPLETED') {

  <app-chunking-settings [groupSizeInput]="chunkingSize" (visualizationData)="onChunkingSliderChange($event)"
                         [comparisonId]="comparisonId"></app-chunking-settings>
  <div class="comparison-container">

    <!-- ===== File Metrics Section ===== -->
    <mat-card class="section-card">
      <mat-card-title>File Specific Metrics of Highest Vegetational Points</mat-card-title>
      <mat-divider></mat-divider>
      <mat-card-content>
        <div class="metrics-list">
          <mat-list>
            <h4>A: {{ vegetationStats().group_mapping.a }}</h4>
            <mat-list-item>Mean: {{ vegetationStats().fileA_metrics.mean_veg_height }}</mat-list-item>
            <mat-list-item>Median: {{ vegetationStats().fileA_metrics.median_veg_height }}</mat-list-item>
            <mat-list-item>Std: {{ vegetationStats().fileA_metrics.std_veg_height }}</mat-list-item>
            <mat-list-item>Min: {{ vegetationStats().fileA_metrics.min_veg_height }}</mat-list-item>
            <mat-list-item>Max: {{ vegetationStats().fileA_metrics.max_veg_height }}</mat-list-item>
            <mat-list-item>Avg. Points: {{ vegetationStats().fileA_metrics.mean_points_per_grid_cell }}</mat-list-item>
          </mat-list>

              <mat-list>
                <h4>B: {{vegetationStats().group_mapping.b}}</h4>
                <mat-list-item>Mean: {{ vegetationStats().fileB_metrics.mean_veg_height }}</mat-list-item>
                <mat-list-item>Median: {{ vegetationStats().fileB_metrics.median_veg_height }}</mat-list-item>
                <mat-list-item>Std: {{ vegetationStats().fileB_metrics.std_veg_height }}</mat-list-item>
                <mat-list-item>Min: {{ vegetationStats().fileB_metrics.min_veg_height }}</mat-list-item>
                <mat-list-item>Max: {{ vegetationStats().fileB_metrics.max_veg_height }}</mat-list-item>
                <mat-list-item>Avg. Points: {{ vegetationStats().fileB_metrics.mean_points_per_grid_cell }}</mat-list-item>
              </mat-list>
            </div>

            <div class="charts-grid">
              <div echarts [options]="{}" [merge]="scatterOption" (chartInit)="onChartInit($event, 'scatter')"
                   class="chart"></div>
              <div echarts [options]="{}" [merge]="boxplotOption" (chartInit)="onChartInit($event, 'boxplot')"
                   class="chart"></div>
              <div echarts [options]="{}" [merge]="fileDistributionOption" (chartInit)="onChartInit($event, 'distribution')"
                   class="chart"></div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- ===== Difference Metrics Section ===== -->
        <mat-card class="section-card">
          <mat-card-title>Difference Metrics (B - A)</mat-card-title>
          <mat-divider></mat-divider>
          <mat-card-content>
            <p>The difference metrics show how much the maximum vegetational height of File B differs from the one of File
              A for each cell.</p>

            <mat-list>
              <mat-list-item>Mean: {{ vegetationStats().difference_metrics.mean }}</mat-list-item>
              <mat-list-item>Median: {{ vegetationStats().difference_metrics.median }}</mat-list-item>
              <mat-list-item>Std: {{ vegetationStats().difference_metrics.std }}</mat-list-item>
              <mat-list-item>Most Negative: {{ vegetationStats().difference_metrics.most_negative }}</mat-list-item>
              <mat-list-item>Least Negative: {{ vegetationStats().difference_metrics.least_negative }}</mat-list-item>
              <mat-list-item>Smallest Positive: {{ vegetationStats().difference_metrics.smallest_positive }}
              </mat-list-item>
              <mat-list-item>Largest Positive: {{ vegetationStats().difference_metrics.largest_positive }}</mat-list-item>
            </mat-list>

            <div class="charts-grid">
              <div echarts [options]="{}" [merge]="diffDistributionOption"
                   (chartInit)="onChartInit($event, 'distribution_diff')" class="chart"></div>
              <div echarts [options]="{}" [merge]="diffHistogramOption" (chartInit)="onChartInit($event, 'histo_diff')"
                   class="chart"></div>
              <!-- TODO check if needed
                <div echarts [options]="categoryBarChart" class="chart"></div>
                -->
            </div>
          </mat-card-content>
        </mat-card>

    <mat-card class="section-card">
      <mat-card-title>
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <span>Heatmaps of Vegetational Heights</span>
          @if (comparison()!.needOutlierDetection) {
          <div style="display: flex; align-items: center; gap: 20px; font-size: 0.8em; font-weight: normal;">
            <span>Std Dev Factor: <strong>{{ comparison()!.outlierDeviationFactor }}</strong></span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <mat-checkbox [checked]="showOutlierDots()" (change)="onOutlierToggle()" color="primary">
                Show Outliers
              </mat-checkbox>
              <mat-icon
                style="font-size: 18px; width: 18px; height: 18px; color: #666; cursor: help;"
                matTooltip="Toggle visibility of red dots on the heatmaps. Red dots indicate grid cells containing outlier points that exceed the specified standard deviation threshold. This is a visual-only toggle and does not affect the statistical calculations."
                matTooltipPosition="below"
                matTooltipClass="outlier-info-tooltip">
                info_outline
              </mat-icon>
            </div>
          </div>
          }
        </div>
      </mat-card-title>
      <mat-divider></mat-divider>
      <mat-card-content>
        <app-heatmap [groupMapping]="groupMapping()" [data]="sharedChunkingResult" [showOutliers]="showOutlierDots()">
        </app-heatmap>
      </mat-card-content>
    </mat-card>


  </div>
  } @else if (['PREPROCESSING', 'COMPARING'].includes(comparison()!.status)) {
  <div class="flex-center" style="margin-top: 50px;">
    <mat-spinner></mat-spinner>
  </div>
  }
</div>
}
@if (comparison()!.status === 'FAILED' || comparison()!.status === 'COMPLETED') {
<div class="delete-button-container comparison-delete-button">
  <button matButton="filled" color="warn" (click)="onDeleteComparison()">
    <mat-icon>delete</mat-icon>
    Delete Comparison
  </button>
</div>
}
}
