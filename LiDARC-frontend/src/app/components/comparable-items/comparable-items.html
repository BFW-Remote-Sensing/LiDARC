<div style="padding: 30px;">
  <div class="upper-section">
    <div class="upper-action-section">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter Items by Name</mat-label>
        <input matInput (keyup)="applyFilter($event)" (keydown.enter)="applyFilter($event)"
          placeholder="Ex. xyz.laz / My Folder Name" #input>
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="goToComparison()"
        [disabled]="selectedItemService.items.size < 2">
        Compare
      </button>
      <div class="selected-items-display">
        @for (item of selectedItemService.items; track item.id) {
        <mat-chip-row (removed)="selectedItemService.items.delete(item)" class="chip">
          <div class="chip-content">
            <mat-icon class="type-icon">{{ getIconForType(item.type) }}</mat-icon>
            {{item.name}}
            <button matChipRemove>
              <mat-icon class="remove-icon">cancel</mat-icon>
            </button>
          </div>
        </mat-chip-row>
        }
      </div>
    </div>
    <button mat-raised-button color="warn" (click)="deleteSelectedFiles()"
      [disabled]="selectedItemService.items.size === 0">
      Delete
    </button>
  </div>
  @if (loading()) {
  <div class="flex-center">
    <mat-spinner></mat-spinner>
  </div>
  } @else if (errorMessage()) {
  <app-text-card type="error" message="{{ errorMessage() }}"></app-text-card>
  } @else if (dataSource.data.length === 0) {
  <app-text-card type="info" message="No comparable items found."></app-text-card>
  } @else {
  <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" style="width: 100%;">

    <!-- Select Column (Checkbox) -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element">
        <mat-checkbox
          [disabled]="element.status !== 'PROCESSED' || (selectedItemService.items.size >= 2 && !isSelected(element))"
          [checked]="isSelected(element)" (change)="toggleSelection(element, $event)">
        </mat-checkbox>
      </td>
    </ng-container>

    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Name</th>
      <td mat-cell *matCellDef="let element">{{ element.originalFilename || element.name }}</td>
    </ng-container>

    <ng-container matColumnDef="type">
      <th mat-header-cell *matHeaderCellDef>Type</th>
      <td mat-cell *matCellDef="let element">{{ element.type }}</td>
    </ng-container>

    <ng-container matColumnDef="fileCount">
      <th mat-header-cell *matHeaderCellDef>File Count</th>
      <td mat-cell *matCellDef="let element">{{ element.fileCount }}</td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let element" [ngClass]="{
        'status-ready': element.status === 'PROCESSED',
        'status-error': element.status === 'FAILED',
        'status-default': element.status === 'UPLOADED' || element.status === 'PROCESSING'
    }">
        <div style="display: flex; column-gap: 10px;">
          <span>{{ element.status }}</span>
          @if (element.status === 'PROCESSING') {
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          }
        </div>
      </td>
    </ng-container>

    <!-- Capture Year Column -->
    <ng-container matColumnDef="captureYear">
      <th mat-header-cell *matHeaderCellDef>Capture Year</th>
      <td mat-cell *matCellDef="let element">{{ element.captureYear ?? '-' }}</td>
    </ng-container>

    <!-- Size Bytes Column -->
    <ng-container matColumnDef="sizeBytes">
      <th mat-header-cell *matHeaderCellDef>Size</th>
      <td mat-cell *matCellDef="let element">{{
        element.sizeBytes != null ? (element.sizeBytes | formatBytes) :
        '-'
        }}
      </td>
    </ng-container>

    <!-- Uploaded At Column -->
    <ng-container matColumnDef="uploadedAt">
      <th mat-header-cell *matHeaderCellDef>Uploaded/Created At</th>
      <td mat-cell *matCellDef="let element">{{ element.uploadedAt | date: 'MMM d, y, HH:mm' }}</td>
    </ng-container>

    <!-- Actions Column -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element" style="text-align: right">
        <a [routerLink]="[element.type === 'File' ? '/stored-files' : '/folders', element.id]">
          <button mat-icon-button matTooltip="View Details" matTooltipPosition="right">
            <mat-icon>visibility</mat-icon>
          </button>
        </a>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
  }
  <div [hidden]="loading() || errorMessage() || dataSource.data.length === 0" style="margin-top: 20px">
    <mat-paginator [length]="totalItems" [pageSize]="pageSize" [pageIndex]="pageIndex"
      [pageSizeOptions]="[10, 15, 20, 1]" showFirstLastButtons (page)="onPageChange($event)">
    </mat-paginator>
  </div>
</div>